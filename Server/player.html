<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://unpkg.com/tailwindcss@0.3.0/dist/tailwind.min.css" rel="stylesheet">
	<Title>Pi MusicSRV</Title>
	<script type="text/javascript">
		var currentlyPlayingTotalSeconds = 0;
		var currentlyPlayingURL = "";

		function spotifyAuth() {
			fetch('/spotify/auth')
				.then(response => response.json())
				.then(data => {
					if (data.redirect == true) {
						window.open(data.spotifyURL);
					}
				});
		}
		function openSongTrackPage() {
			if (currentlyPlayingURL) {
				window.open(currentlyPlayingURL);
			}
		}
		function pause() {
			fetch('/player/pause')
				.then(response => response.json())
				.then(data => console.log(data));
		}
		function setCurrentlyPlayingInfo(data) {
			//document.getElementById("CurrentlyPlayingTitle").innerText = "Loading...";
			//fetch('/player/current/info')
			//	.then(response => response.json())
			//	.then(data => {
					if (data.type == "none") {
						console.log("No song currently playing");
					}
					else if (data.type == "file") {
						let song = data.song;
						//Set up reading in audio file tags then get this all set up
						document.getElementById("CurrentlyPlayingTitle").innerText = song.name;
						document.getElementById("CurrentlyPlayingArtist").innerText = "";
						document.getElementById("CurrentlyPlayingImageUrl").src = "";
						document.getElementById('source_icon').hidden = true;
					}
					else if (data.type == "soundcloud") {
						let song = data.song;
						document.getElementById('source_icon').hidden = false;
						document.getElementById('source_icon_image').src = "https://w.soundcloud.com/icon/assets/images/orange_white_48-94fc761.png";
						document.getElementById("CurrentlyPlayingTitle").innerText = song.title;
						document.getElementById("CurrentlyPlayingArtist").innerText = song.user.username;
						document.getElementById("CurrentlyPlayingImageUrl").src = song.artwork_url.replace("large.jpg", "t500x500.jpg");
						document.getElementById("CurrentlyPlayingProgress").innerText = "0:00";
						currentlyPlayingTotalSeconds = Math.round(song.duration / 1000);
						document.getElementById("CurrentlyPlayingLength").innerText = new Date(currentlyPlayingTotalSeconds * 1000).toISOString().slice(14, 19);
						document.getElementById("ProgressBarPosition").style.width = "0.00%";
						currentlyPlayingURL = data.permalink_url;
					}
					else if (data.type == "spotify") {
						let song = data.song;
						document.getElementById('source_icon').hidden = false;
						document.getElementById('source_icon_image').src = "https://1000logos.net/wp-content/uploads/2017/08/Spotify-Logo.png";
						document.getElementById("CurrentlyPlayingTitle").innerText = song.name;
						document.getElementById("CurrentlyPlayingArtist").innerText = song.artists.map(x => x.name).join();
						document.getElementById("CurrentlyPlayingImageUrl").src = song.album.images[0].url;
						document.getElementById("CurrentlyPlayingProgress").innerText = "0:00";
						currentlyPlayingTotalSeconds = Math.round(song.duration_ms / 1000);
						document.getElementById("CurrentlyPlayingLength").innerText = new Date(currentlyPlayingTotalSeconds * 1000).toISOString().slice(14, 19);
						document.getElementById("ProgressBarPosition").style.width = "0.00%";
						currentlyPlayingURL = song.external_urls.spotify;
					}
			//	});
		}
		function setProgressBarPosition(pct)
		{
			document.getElementById("ProgressBarPosition").style.width = pct + "%";
		}
		function getClickPosition(e) {
			var barLeft = getPosition(e.currentTarget).x;
			var barWidth = document.getElementById("ProgressBarFull").offsetWidth;
			var xPosition = e.clientX - barLeft;
			var pct = (xPosition / barWidth) * 100

			socket.emit('seek', Math.round(currentlyPlayingTotalSeconds * (pct / 100)));
			setProgressBarPosition(pct);

		}
		// Helper function to get an element's exact position
		function getPosition(el) {
			var xPos = 0;
			var yPos = 0;

			while (el) {
				if (el.tagName == "BODY") {
					// deal with browser quirks with body/window/document and page scroll
					var xScroll = el.scrollLeft || document.documentElement.scrollLeft;
					var yScroll = el.scrollTop || document.documentElement.scrollTop;

					xPos += (el.offsetLeft - xScroll + el.clientLeft);
					yPos += (el.offsetTop - yScroll + el.clientTop);
				} else {
					// for all other non-BODY elements
					xPos += (el.offsetLeft - el.scrollLeft + el.clientLeft);
					yPos += (el.offsetTop - el.scrollTop + el.clientTop);
				}

				el = el.offsetParent;
			}
			return {
				x: xPos,
				y: yPos
			};
		}
		function populateFiles() {
			fetch('/songs/files')
				.then(response => response.json())
				.then(data => {
					document.getElementById('source_icon').hidden = true;
					var songDisplayArea = document.getElementById("SongDisplayArea");
					songDisplayArea.innerHTML = '';
					var songList = document.createElement("ul");
					songList.className = "px-0";
					songDisplayArea.appendChild(songList);
					/*songDisplayArea.innerHTML = `<ul class="px-0">
  												<li class="border list-none rounded-sm px-3 py-3" style='border-bottom-width:0'>List Item 1</li>
												</ul>`*/
					for (i = 0; i < data.local_files.length; i++) {
						console.log(data.local_files[i])
                        var songItem = document.createElement("li");
						songItem.className = "border list-none rounded-sm px-2 py-2 hover:bg-blue-200";
						songItem.style = 'border-bottom-width:0; cursor:pointer';
						songItem.innerText = data.local_files[i];
						songItem.addEventListener('click', function(){ playFile(this.innerText); });
						songList.appendChild(songItem);
                    }
				});
		}
		function playFile(song) {
			console.log(song)
			fetch('/player/play/file', {
				method: 'post',
    			headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({file_name: song})
			})
				.then(response => response.json())
				.then(data => {
					console.log(data)
				});
		}
		function populateSoundCloudLikes() {
			fetch('/songs/soundcloud/likes')
				.then(response => response.json())
				.then(data => {
					var songDisplayArea = document.getElementById("SongDisplayArea");
					songDisplayArea.innerHTML = '';
					var songList = document.createElement("ul");
					songList.className = "px-0";
					songDisplayArea.appendChild(songList);
					/*songDisplayArea.innerHTML = `<ul class="px-0">
  												<li class="border list-none rounded-sm px-3 py-3" style='border-bottom-width:0'>List Item 1</li>
												</ul>`*/
					for (i = 0; i < data.likes.length; i++) {
						console.log(data.likes[i].track.title)
                        var songItem = document.createElement("li");
						songItem.className = "border list-none rounded-sm px-2 py-2 hover:bg-blue-200";
						songItem.style = 'border-bottom-width:0; cursor:pointer';
						songItem.innerText = data.likes[i].track.title;
						songItem.songJSON = data.likes[i].track;
						songItem.addEventListener('click', function(){ playSoundCloudSong(this.songJSON); });
						songList.appendChild(songItem);
                    }
				});
		}
		function playSoundCloudSong(song) {
			fetch('/player/play/soundcloud', {
				method: 'post',
    			headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({soundcloud_song: song})
			}).then(response => response.json())
				.then(data => {
					console.log(song)
				});
		}
		function populateSpotifyLikes() {
			fetch('/songs/spotify/likes')
				.then(response => response.json())
				.then(data => {
					var songDisplayArea = document.getElementById("SongDisplayArea");
					songDisplayArea.innerHTML = '';
					var songList = document.createElement("ul");
					songList.className = "px-0";
					songDisplayArea.appendChild(songList);
					/*songDisplayArea.innerHTML = `<ul class="px-0">
  												<li class="border list-none rounded-sm px-3 py-3" style='border-bottom-width:0'>List Item 1</li>
												</ul>`*/
					for (i = 0; i < data.likes.length; i++) {
						console.log(data.likes[i].track.name)
                        var songItem = document.createElement("li");
						songItem.className = "border list-none rounded-sm px-2 py-2 hover:bg-blue-200";
						songItem.style = 'border-bottom-width:0; cursor:pointer';
						songItem.innerText = data.likes[i].track.artists.map(x => x.name).join(', ') + " - " + data.likes[i].track.name;
						songItem.songJSON = data.likes[i].track;
						songItem.addEventListener('click', function(){ playSpotifySong(this.songJSON); });
						songList.appendChild(songItem);
                    }
				});
		}
		function playSpotifySong(song) {
			console.log()
			fetch('/player/play/spotify', {
				method: 'post',
    			headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({spotify_song: song})
			}).then(response => response.json())
				.then(data => {
					console.log(song)
				});
		}
	</script>
</head>

<body onload="setCurrentlyPlayingInfo()" class="h-screen overflow-hidden flex items-center justify-center bg-red-lightest">

	<div class="w-full">

		<div class="flex justify-center h-1/2 my-8">
			<div onclick="populateFiles()" class="m-8 bg-grey-dark rounded-lg cursor-pointer">
				<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/59/OneDrive_Folder_Icon.svg/512px-OneDrive_Folder_Icon.svg.png" alt="Pi Music folder" width="150">
			</div>
			<div onclick="populateSoundCloudLikes()" class="m-8 bg-grey-dark rounded-lg cursor-pointer">
				<img src="https://d21buns5ku92am.cloudfront.net/26628/images/293815-SC_Logo_Vertical_Orange_2x-222df3-large-1539945617.png" alt="Soundcloud" width="200">
			</div>
			<div onclick="populateSpotifyLikes()" class="m-8 bg-grey-dark rounded-lg cursor-pointer">
				<img src="https://1000logos.net/wp-content/uploads/2017/08/Spotify-Logo.png" alt="Spotify" width="180">
			</div>
			<div onclick="spotifyAuth()" class="m-8 bg-grey-dark rounded-lg cursor-pointer">
				<img src="https://1000logos.net/wp-content/uploads/2017/08/Spotify-Logo.png" alt="Spotify settings" width="40">
			</div>
		</div>
		
		<div id="SongDisplayArea" class="flex flex-col mx-auto overflow-y w-1/3">Local files:
		</div>

		<div class="flex items-center justify-center h-1/2">
			<div class="bg-white shadow-lg rounded-lg" style="width: 45rem !important;">
				<div class="flex">
					<div>
						<img id="CurrentlyPlayingImageUrl" class="w-full rounded hidden md:block"
							src="https://tailwindcss.com/img/card-top.jpg" alt="Album Pic">
					</div>
					<div class="w-full p-4">
						<div class="flex justify-between">
							<div>
								<h3 id="CurrentlyPlayingTitle" class="text-xl text-grey-darkest font-medium">Song Title</h3>
								<p id="CurrentlyPlayingArtist" class="text-sm text-grey mt-1">Artist</p>
							</div>
							<div id="source_icon" style="cursor: pointer;" onclick="openSongTrackPage()" hidden="true">
								<img id="source_icon_image" src="https://w.soundcloud.com/icon/assets/images/orange_white_48-94fc761.png" alt="Source icon" width="50" height="50">
							</div>
						</div>
						<div class="flex justify-between items-center mt-8">
							<div class="text-grey-darker">
								<svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 20 20">
									<path
										d="M6.59 12.83L4.4 15c-.58.58-1.59 1-2.4 1H0v-2h2c.29 0 .8-.2 1-.41l2.17-2.18 1.42 1.42zM16 4V1l4 4-4 4V6h-2c-.29 0-.8.2-1 .41l-2.17 2.18L9.4 7.17 11.6 5c.58-.58 1.59-1 2.41-1h2zm0 10v-3l4 4-4 4v-3h-2c-.82 0-1.83-.42-2.41-1l-8.6-8.59C2.8 6.21 2.3 6 2 6H0V4h2c.82 0 1.83.42 2.41 1l8.6 8.59c.2.2.7.41.99.41h2z" />
								</svg>
							</div>
							<div class="text-grey-darker">
								<svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 20 20">
									<path d="M4 5h3v10H4V5zm12 0v10l-9-5 9-5z" />
								</svg>
							</div>
							<div class="text-white p-8 rounded-full bg-red-light shadow-lg cursor-pointer" onclick="pause()">
								<svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 20 20">
									<path d="M5 4h3v12H5V4zm7 0h3v12h-3V4z" />
								</svg>
							</div>
							<div class="text-grey-darker">
								<svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 20 20">
									<path d="M13 5h3v10h-3V5zM4 5l9 5-9 5V5z" />
								</svg>
							</div>
							<div class="text-grey-darker">
								<svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 20 20">
									<path
										d="M5 4a2 2 0 0 0-2 2v6H0l4 4 4-4H5V6h7l2-2H5zm10 4h-3l4-4 4 4h-3v6a2 2 0 0 1-2 2H6l2-2h7V8z" />
								</svg>
							</div>
						</div>
					</div>
				</div>
				<div class="mx-8 py-4">
					<div class="flex justify-between text-sm text-grey-darker">
						<p id="CurrentlyPlayingProgress">0:00</p>
						<p id="CurrentlyPlayingLength">4:20</p>
					</div>
					<div class="mt-1">
						<div id="ProgressBarFull" class="h-3 bg-grey-dark rounded-full" style="cursor: pointer;">
							<div id="ProgressBarPosition" class="h-3 bg-red-light rounded-full relative"
								style="width: 0%">
								<!--<span class="w-4 h-4 bg-red absolute pin-r pin-b -mb-1 rounded-full shadow"></span>-->
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<p id="ServerConnectionStatus"></p>

	<script src="/socket.io/socket.io.js"></script>
	<script>
	  var socket = io();

	  document.getElementById("ProgressBarFull").addEventListener("click", getClickPosition, false);

	  socket.on('set_song_progress', function(seconds) {
		if (seconds == (currentlyPlayingTotalSeconds - 1)) { //Seems like the VLC player rounds down for seconds, so if we rounded up it probably won't match and we have to manually set it here
			document.getElementById("CurrentlyPlayingProgress").innerText = document.getElementById("CurrentlyPlayingLength").innerText;
			document.getElementById("ProgressBarPosition").style.width = "100.00%";
			return;
		}
		var secs = parseInt(seconds);
		var playerSeconds = new Date(secs * 1000).toISOString().slice(14, 19);
		var playerProgressPct = (secs / currentlyPlayingTotalSeconds) * 100;

		document.getElementById("CurrentlyPlayingProgress").innerText = playerSeconds;
		document.getElementById("ProgressBarPosition").style.width = playerProgressPct + "%";
	  });
	  socket.on('connection_status', function(status) {
		document.getElementById("ServerConnectionStatus").innerText = status;
	  });
	  socket.on('popup_message', function(message) {
		alert(message);
	  });
	  socket.on('update_song_info', function(data) {
		  setCurrentlyPlayingInfo(data);
	  })
	</script>
</body>

</html>